<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Pedidos - Panel Admin</title>
    


    <style>
        #filtros button {
    background:#d7c2aa;
    color:#4e321f;
    border:none;
    padding:6px 12px;
    border-radius:6px;
    cursor:pointer;
}
#filtros button.activo {
    background:#8c5e3c;
    color:white;
}
        body {
            font-family: Poppins, sans-serif;
            background: #f8f4ee;
            padding: 20px;
        }

        h1 {
            color: #8c5e3c;
            margin-bottom: 5px;
        }

        a button {
            margin-bottom: 20px;
            background: #8c5e3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 6px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
        }

        th, td {
            border: 1px solid #d2bda5;
            padding: 10px;
        }

        th {
            background: #ebdfd1;
        }

        button {
            padding: 5px 10px;
            border: none;
            cursor: pointer;
            border-radius: 6px;
        }

        .btn-estado {
            background: #6e472d;
            color: white;
        }

        .btn-delete {
            background: #b44444;
            color: white;
        }

        .detalle-box {
            background: #f7efe7;
            padding: 10px;
            margin-top: 5px;
            border-radius: 6px;
        }
    </style>

</head>
<body>

<h1>Pedidos Recibidos</h1>

<button onclick="window.location.href='/admin-panel.html'">‚Üê Volver al Panel</button>

<!-- üîé FILTROS -->
<div id="filtros" style="margin:15px 0; display:flex; gap:10px; flex-wrap:wrap;">
    <!-- Tabs de tipo -->
    <button onclick="cambiarTab('todos')"  id="tab-todos">Todos</button>
    <button onclick="cambiarTab('recientes')" id="tab-recientes">Pedidos recientes</button>
    <button onclick="cambiarTab('terminados')" id="tab-terminados">Terminados</button>

    <!-- B√∫squeda -->
    <input id="f-buscar" placeholder="Buscar por ID o producto" onkeyup="aplicarFiltros()">

    <!-- Filtro por m√©todo de pago -->
    <select id="f-metodo" onchange="aplicarFiltros()">
        <option value="">M√©todo pago</option>
        <option value="MERCADO_PAGO">Mercado Pago</option>
        <option value="EFECTIVO">Efectivo</option>
    </select>

    <!-- Filtro por estado -->
    <select id="f-estado" onchange="aplicarFiltros()">
        <option value="">Estado</option>
        <option value="PENDIENTE">Pendiente</option>
        <option value="PAGADO">Pagado</option>
        <option value="ENTREGADO">Entregado</option>
    </select>
</div>

<table id="tablaPedidos">
    <thead>
    <tr>
        <th onclick="cambiarOrden('id')">ID ‚¨ç</th>
<th onclick="cambiarOrden('fecha')">Fecha ‚¨ç</th>
<th onclick="cambiarOrden('total')">Total ‚¨ç</th>
<th onclick="cambiarOrden('descuento')">Descuento ‚¨ç</th>
<th>M√©todo Pago</th>
<th>Estado</th>
<th>Detalle</th>
<th>Acciones</th>

    </tr>
    </thead>
    <tbody></tbody>
</table>


<script>
const API_URL = "https://cuitibackmystere.onrender.com";

if (!localStorage.getItem("admin")) {
    window.location.href = "admin-login.html";
}

let pedidosTodos = [];
let tabActual = "recientes";
let ordenCampo = "fecha";
let ordenAsc = false;

async function cargarPedidos() {
    const res = await fetch(`${API_URL}/api/admin/pedidos`);
    pedidosTodos = await res.json();
    aplicarFiltros();
}
cargarPedidos();

function cambiarTab(tab) {
    tabActual = tab;
    document.querySelectorAll("#filtros button").forEach(b => b.classList.remove("activo"));
    document.getElementById("tab-"+tab).classList.add("activo");
    aplicarFiltros();
}

function aplicarFiltros() {
    let lista = [...pedidosTodos];

    if (tabActual === "recientes") lista = lista.filter(p => p.estado !== "ENTREGADO");
    if (tabActual === "terminados") lista = lista.filter(p => p.estado === "ENTREGADO");

    renderPedidos(lista);
}

function renderPedidos(pedidos) {
    const tbody = document.querySelector("#tablaPedidos tbody");
    tbody.innerHTML = "";

    pedidos.forEach(p => {
        tbody.innerHTML += `
        <tr>
            <td>${p.id}</td>
            <td>${p.fecha?.replace("T"," ")}</td>
            <td>$${p.total}</td>
            <td>$${p.descuento ?? 0}</td>
            <td>${p.metodoPago}</td>
            <td>${p.estado}</td>
            <td>${p.detalle}</td>
            <td>
                <button onclick="cambiarEstado(${p.id},'ENTREGADO')">Terminar</button>
                <button onclick="borrarPedido(${p.id})" style="background:#b44444">Eliminar</button>
            </td>
        </tr>`;
    });
}

async function cambiarEstado(id, estado) {
    await fetch(`${API_URL}/api/admin/pedidos/${id}/estado?estado=${estado}`, {
        method: "PUT"
    });
    cargarPedidos();
}

async function borrarPedido(id) {
    if (!confirm("¬øEliminar pedido?")) return;

    await fetch(`${API_URL}/api/admin/pedidos/${id}`, {
        method: "DELETE"
    });

    cargarPedidos();
}
</script>

</body>
</html>
